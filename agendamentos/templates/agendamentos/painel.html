{% extends "agendamentos/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css">

<style>
  :root { --fc-event-text-color: #FFFFFF; }
  body { font-family: 'Poppins', sans-serif !important; }

  /* ---- CALENDÁRIO ---- */
  #calendar {
    font-family: 'Poppins', sans-serif;
    border-radius: 20px;
    overflow: hidden;
    border: 1.5px solid #ecd7b3;
    padding: 1rem;
    background-color: #fff;
    box-shadow: 0 10px 30px rgba(200,180,90,0.10);
    min-height: 70vh;
    position: relative;
  }

  .fc .fc-toolbar-title { font-size: 2.1rem !important; font-weight: 700; color: #8c6c21; }
  .fc .fc-toolbar.fc-header-toolbar { gap: .6rem; }

  .fc .fc-button {
    border-radius: 9999px !important;
    padding: .45rem .9rem !important;
    font-weight: 600 !important;
    box-shadow: 0 4px 12px rgba(166,124,0,.12);
  }
  .fc .fc-button-primary,
  .fc .fc-button-primary:focus,
  .fc .fc-button-primary:hover { background-color: #a67c00; border-color: #a67c00; }

  .fc .fc-day-today {
    background-color: rgba(166,124,0,0.08) !important;
    outline: 2px solid #a67c00;
    outline-offset: -2px;
    border-radius: 8px;
  }

  .fc-day-sat .fc-daygrid-day-frame,
  .fc-day-sun .fc-daygrid-day-frame {
    background: linear-gradient(180deg, rgba(166,124,0,0.04), transparent 40%);
  }

  .fc .fc-event {
    border-radius: 12px !important;
    border-width: 2px !important;
    border-style: solid !important;
    padding: 2px 6px !important;
    font-size: .95rem !important;
  }

  .fc-theme-standard .fc-scrollgrid { border-radius: 14px; }

  /* Dark mode */
  body.dark-mode #calendar { background-color: #232325; border-color: #574b2b; }
  body.dark-mode .fc-theme-standard .fc-scrollgrid { background: #2a2a45; }
  body.dark-mode .fc .fc-day-today { background-color: rgba(140,108,33,.28) !important; }
  body.dark-mode h1, body.dark-mode .lead { color: #ffe395; }
  body.dark-mode .modal-header { background-color: #8c6c21; }

  /* Switch de tema */
  .theme-switch-wrapper{display:flex;align-items:center;color:#8c6c21;}
  .theme-switch{display:inline-block;height:24px;position:relative;width:48px}
  .theme-switch input{display:none}
  .slider{background-color:#ccc;bottom:0;cursor:pointer;left:0;position:absolute;right:0;top:0;transition:.4s}
  .slider:before{background-color:#fff;bottom:4px;content:"";height:16px;left:4px;position:absolute;transition:.4s;width:16px}
  input:checked+.slider{background-color:#a67c00}
  input:checked+.slider:before{transform:translateX(24px)}
  .slider.round{border-radius:34px}
  .slider.round:before{border-radius:50%}
  body.dark-mode .theme-switch-wrapper{color:#ffe395;}

  /* Flyout horários */
  .slots-flyout{
    position: absolute; z-index: 3000; min-width: 220px; max-width: 260px;
    background: rgba(255,255,255,.98); border: 1px solid #ecd7b3; border-radius: 12px;
    box-shadow: 0 10px 30px rgba(200,180,90,.18); padding: 10px; pointer-events: none;
  }
  .slots-flyout h6{ margin: 0 0 6px 0; font-weight: 700; font-size: .95rem; color:#8c6c21; }
  .slots-flyout .slot{
    display:inline-block; margin: 4px 6px 0 0; padding: 3px 8px; border-radius: 999px;
    font-size: .82rem; border:1px solid #a67c00; color:#a67c00; background: #fff; opacity:.9;
  }
  .slots-flyout .slot.disabled{ border-color:#bbb; color:#888; text-decoration: line-through; }
  body.dark-mode .slots-flyout{ background:#232325; border-color:#574b2b }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="display-6 fw-light">Painel de Agendamentos</h1>
    <p class="lead text-muted mb-0">Visualize seus compromissos e clique em um horário vago para agendar.</p>
  </div>
  <div class="theme-switch-wrapper">
    <i class="bi bi-brightness-high-fill me-2"></i>
    <label class="theme-switch" for="theme-switch-checkbox">
      <input type="checkbox" id="theme-switch-checkbox" />
      <div class="slider round"></div>
    </label>
    <i class="bi bi-moon-stars-fill ms-2"></i>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body p-lg-4 p-2">
    <div id="calendar" data-events-url="{% url 'agendamentos:api_agendamentos' %}"></div>
  </div>
</div>

<!-- Modal Detalhes -->
<div class="modal fade" id="appointmentModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header text-white" style="background:#a67c00;">
        <h5 class="modal-title">Detalhes do Agendamento</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Cliente:</strong> <span id="modal-cliente-nome"></span></p>
        <p><strong>Serviço:</strong> <span id="modal-servico-nome"></span></p>
        <p><strong>Data e Hora:</strong> <span id="modal-data-hora"></span></p>
        <p><strong>Status:</strong> <span id="modal-status" class="badge"></span></p>
        <hr>
        <p><i class="bi bi-telephone"></i> <span id="modal-cliente-telefone"></span></p>
        <p><i class="bi bi-envelope"></i> <span id="modal-cliente-email"></span></p>
        <div id="modal-whats-container" class="mt-3"></div>
      </div>
      <div class="modal-footer">
        <a href="#" id="modal-edit-link" class="btn btn-outline-secondary">Gerenciar Agendamento</a>
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Novo Agendamento -->
<div class="modal fade" id="newAppointmentModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header text-white" style="background:#a67c00;">
        <h5 class="modal-title">Novo Agendamento</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Selecione um serviço para o dia <strong id="new-appointment-time"></strong>:</p>
        <div class="list-group" id="service-list"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core/locales/pt-br.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // ---------- Tema (dark / light) ----------
  function applyTheme(theme){
    document.body.classList.toggle('dark-mode', theme === 'dark');
    document.getElementById('theme-switch-checkbox').checked = theme === 'dark';
  }
  const themeSwitch = document.getElementById('theme-switch-checkbox');
  const savedTheme = localStorage.getItem('theme') || 'light';
  applyTheme(savedTheme);
  themeSwitch.addEventListener('change', e => {
    const t = e.target.checked ? 'dark' : 'light';
    localStorage.setItem('theme', t);
    applyTheme(t);
  });

  // ---------- Utils ----------
  function pad2(n){ return String(n).padStart(2,'0'); }
  function formatPtBR(date){
    try{
      return date.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
    }catch(e){
      return `${pad2(date.getDate())}/${pad2(date.getMonth()+1)}/${date.getFullYear()} ${pad2(date.getHours())}:${pad2(date.getMinutes())}`;
    }
  }
  function normalizePhoneBR(phone){
    if(!phone) return '';
    let p = String(phone).replace(/[^\d]/g,'');
    if(p.length >= 10 && !p.startsWith('55')) p = '55' + p;
    return p;
  }

  // ---------- Elementos ----------
  const calendarEl = document.getElementById('calendar');
  const appointmentModalEl = document.getElementById('appointmentModal');
  const newAppointmentModalEl = document.getElementById('newAppointmentModal');
  if (!calendarEl || !appointmentModalEl || !newAppointmentModalEl) return;

  const appointmentModal = new bootstrap.Modal(appointmentModalEl);
  const newAppointmentModal = new bootstrap.Modal(newAppointmentModalEl);
  const serviceListEl = document.getElementById('service-list');
  const newAppointmentTimeEl = document.getElementById('new-appointment-time');

  const servicos = JSON.parse('{{ servicos_json|escapejs }}');
  const defaultServiceId = servicos.length ? servicos[0].id : null;

  // ---------- Flyout de horários (usa API correta) ----------
  let flyoutEl = null, flyoutTimer = null;
  function ensureFlyout(){
    if(!flyoutEl){
      flyoutEl = document.createElement('div');
      flyoutEl.className = 'slots-flyout';
      flyoutEl.style.display = 'none';
      document.body.appendChild(flyoutEl);
    }
    return flyoutEl;
  }
  function hideFlyoutSoon(delay=1800){
    clearTimeout(flyoutTimer);
    flyoutTimer = setTimeout(()=>{ if(flyoutEl) flyoutEl.style.display='none'; }, delay);
  }
  async function showSlotsFlyout(dateISO, anchorRect){
    if(!defaultServiceId) return;
    const el = ensureFlyout();
    el.innerHTML = '<h6>Horários disponíveis</h6><div id="slots-mini">Carregando...</div>';
    el.style.display = 'block';
    const scrollY = window.scrollY || document.documentElement.scrollTop;
    el.style.left = (anchorRect.left + window.scrollX + 4) + 'px';
    el.style.top  = (anchorRect.bottom + scrollY + 6) + 'px';
    try{
      const url = "{% url 'agendamentos:api_horarios_disponiveis' %}?servico_id="+defaultServiceId+"&data="+dateISO;
      const res = await fetch(url);
      const data = await res.json();
      const box = el.querySelector('#slots-mini');
      box.innerHTML = '';
      (data.horarios || []).forEach(h=>{
        const b = document.createElement('span');
        b.className = 'slot';
        b.textContent = h;
        box.appendChild(b);
      });
      if(!(data.horarios||[]).length){
        box.innerHTML = '<span class="text-muted">Sem horários livres</span>';
      }
    }catch(e){
      // silencia erro
    }
    hideFlyoutSoon();
  }

  // ---------- Calendário ----------
  const calendar = new FullCalendar.Calendar(calendarEl, {
    headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek' },
    initialView: 'dayGridMonth',
    locale: 'pt-br',
    buttonText: { today: 'Hoje', month: 'Mês', week: 'Semana', day: 'Dia', list: 'Lista' },
    allDaySlot: false,
    slotMinTime: "09:00:00",
    slotMaxTime: "19:00:00",
    height: '78vh',
    expandRows: true,
    aspectRatio: 1.2,
    dayMaxEventRows: 3,
    nowIndicator: true,
    navLinks: true,
    selectable: true,

    events: calendarEl.dataset.eventsUrl,

    eventDidMount: function(info) {
      info.el.style.borderRadius = '12px';
      info.el.style.padding = '2px 6px';
    },

    dayCellDidMount: function(arg){
      const cell = arg.el;
      const dateISO = arg.date.toISOString().slice(0,10);
      cell.addEventListener('mouseenter', ()=>{
        const rect = cell.getBoundingClientRect();
        showSlotsFlyout(dateISO, rect);
      });
      cell.addEventListener('mouseleave', ()=>{ hideFlyoutSoon(300); });
      cell.addEventListener('touchstart', ()=>{
        const rect = cell.getBoundingClientRect();
        showSlotsFlyout(dateISO, rect);
      }, {passive:true});
      cell.addEventListener('touchend', ()=> hideFlyoutSoon(1600), {passive:true});
    },

    eventClick: function (info) {
      info.jsEvent?.preventDefault?.();
      const start = info.event.start;
      const ext = info.event.extendedProps || {};

      // Tenta extrair serviço/cliente do título "Servico - Cliente"
      let servicoNome = '', clienteNome = '';
      if (info.event.title && info.event.title.includes(' - ')) {
        const [s, c] = info.event.title.split(' - ');
        servicoNome = s || ''; clienteNome = c || '';
      }

      document.getElementById('modal-cliente-nome').textContent = ext.cliente_nome || clienteNome || '';
      document.getElementById('modal-servico-nome').textContent = ext.servico_nome || servicoNome || '';
      document.getElementById('modal-data-hora').textContent = start ? formatPtBR(start) : '';

      const status = ext.status || '';
      const statusEl = document.getElementById('modal-status');
      statusEl.textContent = status || '';
      statusEl.className = 'badge';
      if (status === 'Confirmado') statusEl.classList.add('bg-success');
      else if (status === 'Cancelado') statusEl.classList.add('bg-danger');
      else if (status === 'Realizado') statusEl.classList.add('bg-primary');
      else statusEl.classList.add('bg-secondary');

      document.getElementById('modal-cliente-telefone').textContent = ext.cliente_telefone || '';
      document.getElementById('modal-cliente-email').textContent = ext.cliente_email || '';

      document.getElementById('modal-edit-link').href =
        "{% url 'agendamentos:gerir_agendamentos' %}?data=" + (info.event.startStr || '').substring(0, 10);

      const whatsContainer = document.getElementById('modal-whats-container');
      whatsContainer.innerHTML = '';
      const phone = normalizePhoneBR(ext.cliente_telefone || '');
      if (phone) {
        let msg, btnClass, alertClass, btnText, leadText;
        if ((status || '').toLowerCase() === 'cancelado') {
          leadText = 'Agendamento cancelado.';
          msg = `Olá ${clienteNome || ''}, seu agendamento de ${servicoNome || 'serviço'} em ${formatPtBR(start)} foi cancelado. Podemos remarcar?`;
          btnClass = 'btn btn-danger'; alertClass = 'alert alert-danger';
          btnText = '<i class="bi bi-whatsapp"></i> Enviar cancelamento';
        } else {
          leadText = 'Agendamento confirmado.';
          msg = `Oi ${clienteNome || ''}! Confirmando seu horário de ${servicoNome || 'serviço'} em ${formatPtBR(start)}. Qualquer dúvida, me chame 💖`;
          btnClass = 'btn btn-success'; alertClass = 'alert alert-success';
          btnText = '<i class="bi bi-whatsapp"></i> Enviar confirmação';
        }
        const wa = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
        whatsContainer.innerHTML =
          `<div class="${alertClass} d-flex justify-content-between align-items-center">
            <span>${leadText}</span>
            <a href="${wa}" target="_blank" rel="noopener" class="${btnClass}">${btnText}</a>
          </div>`;
      }

      appointmentModal.show();
    },

    dateClick: function (info) {
      const now = new Date();
      const clicked = new Date(info.dateStr + 'T00:00:00');
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      if (clicked < today) { alert('Não é possível agendar em datas passadas.'); return; }

      newAppointmentTimeEl.textContent = info.dateStr.split('-').reverse().join('/');
      serviceListEl.innerHTML = '';

      servicos.forEach(s => {
        const baseUrl = "{% url 'agendamentos:agendar_servico' 999 %}".replace('999', s.id);
        const url = `${baseUrl}?data=${info.dateStr}`;
        const a = document.createElement('a');
        a.href = url;
        a.className = 'list-group-item list-group-item-action';
        a.innerHTML =
          `<div class="d-flex w-100 justify-content-between">
             <h5 class="mb-1" style="color:#8c6c21;">${s.nome}</h5>
           </div>
           <small>Duração: ${s.duracao || 60} min</small>`;
        serviceListEl.appendChild(a);
      });
      newAppointmentModal.show();
    }
  });

  calendar.render();
});
</script>
{% endblock %}
