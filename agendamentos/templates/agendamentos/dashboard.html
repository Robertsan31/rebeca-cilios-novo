{% extends "agendamentos/base.html" %}
{% load static %}

{% block extra_css %}
<style>
  .kpi-card{border:none;border-radius:18px;box-shadow:0 10px 30px rgba(200,180,90,.10)}
  .kpi-card .value{font-size:2rem;font-weight:700;color:#8c6c21}
  .kpi-card .label{color:#6b6b6b}

  .chart-card{border-radius:18px;border:1.5px solid #ecd7b3;box-shadow:0 10px 30px rgba(200,180,90,.10)}
  body.dark-mode .chart-card{background:#232325;border-color:#574b2b}
  body.dark-mode .kpi-card{background:#232325;color:#ffe395}

  .btn-range{border-radius:9999px}
  .btn-range.active{background:#a67c00;border-color:#a67c00;color:#fff}

  /* Limita o tamanho do gráfico de pizza */
  .chart-wrap{max-width:520px;margin-inline:auto}
  @media (max-width:768px){ .chart-wrap{max-width:360px} }
  @media (max-width:480px){ .chart-wrap{max-width:300px} }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="display-6 fw-light">Dashboard</h1>
    <p class="lead text-muted mb-0">Resumo dos atendimentos e agendamentos.</p>
  </div>
</div>

<!-- KPIs -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card kpi-card p-3">
      <div class="value" id="kpi-hoje">–</div>
      <div class="label">Agendamentos Hoje</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card kpi-card p-3">
      <div class="value" id="kpi-semana">–</div>
      <div class="label">Esta Semana</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card kpi-card p-3">
      <div class="value" id="kpi-mes">–</div>
      <div class="label">Este Mês</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card kpi-card p-3">
      <div class="value" id="kpi-cancelados">–</div>
      <div class="label">Cancelados (mês)</div>
    </div>
  </div>
</div>

<!-- Pizza + seletor -->
<div class="card chart-card p-3 mb-4">
  <div class="d-flex justify-content-between align-items-center">
    <h5 class="m-0" style="color:#8c6c21;">Status dos Agendamentos</h5>
    <div class="btn-group" role="group" aria-label="Intervalo">
      <button class="btn btn-outline-secondary btn-range" data-days="7">7 dias</button>
      <button class="btn btn-outline-secondary btn-range active" data-days="30">30 dias</button>
      <button class="btn btn-outline-secondary btn-range" data-days="90">90 dias</button>
    </div>
  </div>
  <div class="mt-3 chart-wrap">
    <canvas id="graficoPizza"></canvas>
  </div>
</div>

<!-- Tabela simples (últimos 7 dias) -->
<div class="card p-3">
  <h6 class="mb-3">Tabela (últimos 7 dias)</h6>
  <div class="table-responsive">
    <table class="table table-sm align-middle" id="tabela7d">
      <thead>
        <tr>
          <th>Data</th>
          <th>Confirmados</th>
          <th>Realizados</th>
          <th>Cancelados</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const ctx = document.getElementById('graficoPizza').getContext('2d');
  let pie;

  const rangeBtns = document.querySelectorAll('.btn-range');
  rangeBtns.forEach(b=>b.addEventListener('click', e=>{
    rangeBtns.forEach(x=>x.classList.remove('active'));
    e.currentTarget.classList.add('active');
    carregar(parseInt(e.currentTarget.dataset.days,10));
  }));

  async function carregar(days=30){
    const url = "{% url 'agendamentos:stats' %}?days="+days;
    const res = await fetch(url);
    if(!res.ok){ console.warn('falha ao buscar stats'); return; }
    const data = await res.json();

    // KPIs
    document.getElementById('kpi-hoje').textContent = data.kpis.hoje;
    document.getElementById('kpi-semana').textContent = data.kpis.semana;
    document.getElementById('kpi-mes').textContent = data.kpis.mes;
    document.getElementById('kpi-cancelados').textContent = data.kpis.cancelados_mes;

    // Pizza
    const labels = ['Confirmado','Realizado','Cancelado','Pendente'];
    const valores = [
      data.pie.confirmado, data.pie.realizado, data.pie.cancelado, data.pie.pendente
    ];
    const cores = ['#198754','#0d6efd','#dc3545','#f0ad4e'];

    if(pie) pie.destroy();
    pie = new Chart(ctx, {
      type:'pie',
      data:{ labels, datasets:[{ data: valores, backgroundColor: cores }] },
      options:{ responsive:true, maintainAspectRatio:true, aspectRatio:1, plugins:{ legend:{ position:'bottom' } } }
    });

    // Tabela 7d
    const tbody = document.querySelector('#tabela7d tbody');
    tbody.innerHTML = '';
    (data.tabela7d || []).forEach(l => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l.data}</td><td>${l.confirmados}</td><td>${l.realizados}</td><td>${l.cancelados}</td>`;
      tbody.appendChild(tr);
    });
  }

  carregar(30);
});
</script>
{% endblock %}
