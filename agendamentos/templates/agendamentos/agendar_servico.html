{% extends "agendamentos/base.html" %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-7">
      <div class="card shadow-sm" style="border-radius: 14px;">
        <div class="card-body p-4">
          <h3 class="mb-3" style="color:#5d4a7b;">Agendar — {{ servico.nome }}</h3>

          {% if error_message %}
            <div class="alert alert-danger">{{ error_message }}</div>
          {% endif %}

          <form method="post">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">Data</label>
              <input type="date" id="dia" name="dia" class="form-control" value="{{ dia|date:'Y-m-d' }}">
            </div>

            <div class="mb-3">
              <label class="form-label">Horários disponíveis (1h)</label>
              <div id="slots" class="d-flex flex-wrap gap-2"></div>
              <input type="hidden" name="hora" id="hora">
            </div>

            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary btn-lg">Continuar</button>
              <a href="{% url 'agendamentos:painel' %}" class="btn btn-outline-secondary">Cancelar</a>
            </div>
          </form>

          <hr class="my-4">
          <div class="small text-muted">
            Dica: você chegou aqui pelo calendário. Se preferir, é possível agendar direto pelo painel usando o seletor de data/hora e o botão <b>Confirmar</b>.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
async function carregarSlots(){
  const dia = document.getElementById('dia').value;
  const url = "{% url 'agendamentos:api_horarios_disponiveis' %}?data="+dia;
  const res = await fetch(url); if(!res.ok) return;
  const data = await res.json();
  const box = document.getElementById('slots'); box.innerHTML = '';
  data.slots.forEach(s=>{
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-sm ' + (s.ocupado ? 'btn-outline-secondary' : 'btn-outline-primary');
    btn.textContent = s.hora;
    btn.disabled = s.ocupado;
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('#slots button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('hora').value = s.hora;
    });
    box.appendChild(btn);
  });
}
document.getElementById('dia').addEventListener('change', carregarSlots);
document.addEventListener('DOMContentLoaded', carregarSlots);
</script>
{% endblock %}
